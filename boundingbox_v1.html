<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bounding Box with Canvas</title>
    <link rel="stylesheet" href="style.css">
</head>

<body onload="_bounding_box_init()">
    <div class="annotation_bounding_box">
        <div id="annotation_editor">
            <ul class="list_label">
                <li class="list_label_item">
                    <input type="file" id="imageInput" accept="image/*">
                </li>
            </ul>
        </div>
        <div id="display_area">
            <h1>Bounding Box with Canvas - 2D Bounding Box Annotation</h1>
            <p>Coordinates: <span id="coordinates"></span></p>

            <div id="image_panel" class="display_area_content">
                <canvas id="region_canvas" width="1" height="1" tabindex="1">Sorry, your browser does not support HTML5
                    Canvas functionality which is required for this application.</canvas>
                <img id="selectedImage" src="" alt="Selected Image" class="display_none">
            </div>
        </div>
    </div>


    <script>
        //settings
        var window_width = screen.width;

        var _canvas_scale = 1.0;// current scale of canvas image
        var _canvas_width, _canvas_height;

        //image
        var image_input = document.getElementById('imageInput');
        var _current_image = document.getElementById('selectedImage');
        var _current_image_width;
        var _current_image_height;
        var _canvas_regions_start_x, _canvas_regions_start_y, _canvas_regions_end_x, _canvas_regions_end_y;

        var _annotation_editor = document.getElementById('annotation_editor');
        var _display_area = document.getElementById('display_area');
        var image_panel = document.getElementById('image_panel');
        var _reg_canvas = document.getElementById('region_canvas');
        var _reg_ctx;// initialized in _bounding_box_init()


        var coordinates = document.getElementById('coordinates');
        var isDrawing = false;
        var startPoint = { x: 0, y: 0 };
        var endPoint = { x: 0, y: 0 };

        function _bounding_box_init() {
            _init_reg_canvas_context();
        }

        function _init_reg_canvas_context() {
            _reg_ctx = _reg_canvas.getContext('2d');
        }

        function set_all_canvas_size(w, h) {
            _reg_canvas.height = h;
            _reg_canvas.width = w;

            image_panel.style.width = w + 'px';
            image_panel.style.height = h + 'px';
        }

        document.addEventListener('DOMContentLoaded', function () {
            image_input.addEventListener('change', function (e) {
                e.preventDefault();
                const file = image_input.files[0];

                if (file) {
                    const reader = new FileReader();

                    reader.onload = function (event) {
                        _current_image.src = event.target.result;
                    };

                    reader.readAsDataURL(file);
                }
            });

            _current_image.addEventListener('load', function () {
                let _current_image_width = _current_image.naturalWidth;
                let _current_image_height = _current_image.naturalHeight;

                let canvas_w = image_panel.clientWidth - 20;
                _canvas_scale = canvas_w / _current_image_width
                let canvas_h = _current_image_height * _canvas_scale;
                set_all_canvas_size(canvas_w, canvas_h);
                _reg_ctx.drawImage(_current_image, 0, 0, _reg_canvas.width, _reg_canvas.height);
            });

            _reg_canvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const rect = region_canvas.getBoundingClientRect();
                startPoint = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            });

            _reg_canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const rect = region_canvas.getBoundingClientRect();
                endPoint = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
                const width = endPoint.x - startPoint.x;
                const height = endPoint.y - startPoint.y;

                _reg_ctx.clearRect(0, 0, region_canvas.width, region_canvas.height);
                _reg_ctx.drawImage(_current_image, 0, 0, region_canvas.width, region_canvas.height);
                _reg_ctx.strokeStyle = 'red';
                _reg_ctx.strokeRect(startPoint.x, startPoint.y, endPoint.x - startPoint.x, endPoint.y - startPoint.y);
                _canvas_regions_start_x = Math.round(startPoint.x / _canvas_scale);
                _canvas_regions_start_y = Math.round(startPoint.y / _canvas_scale);
                _canvas_regions_end_x = Math.round(endPoint.x / _canvas_scale);
                _canvas_regions_end_y = Math.round(endPoint.y / _canvas_scale);
                coordinates.textContent = `startPoint.X: ${_canvas_regions_start_x}, startPoint.Y: ${_canvas_regions_start_y}, endPoint.X: ${_canvas_regions_end_x}, endPoint.Y: ${_canvas_regions_end_y}`;
            });

            _reg_canvas.addEventListener('mouseup', () => {
                var data_return = {
                    'image': _current_image.src,
                    'startPoint_x': _canvas_regions_start_x,
                    'startPoint_y': _canvas_regions_start_y,
                    'endPoint_x': _canvas_regions_end_x,
                    'endPoint_y': _canvas_regions_end_y,
                };
                console.log(data_return);
                isDrawing = false;
            });
        });
    </script>
</body>

</html>